<section name="about-project">

이 프로젝트는 Flitz라는 남성 동성애자를 위한 데이팅 앱 서비스의 iOS 앱입니다. 

Flitz 서비스에 대해서는 #service-description 섹션을 참고해주세요.
개발 관련 사항은 #development 섹션을 참고해주세요.

</section>
<section name="service-description">

# NAME

Flitz - 남성 동성애자를 위한 데이팅 앱 서비스

# SYNOPSIS

Flitz는 남성 동성애자를 위한 데이팅 앱 서비스입니다. 포토 카드를 통해 자기 자신을 표현할 수 있고, Bluetooth를 사용한 포토 카드 교환 기능을 통해 사용자들이 실제로 마주쳤거나 지나친 사람들을 발견하고, 소통할 수 있습니다. 

# KEY FEATURES

## 포토 카드 (프로필 카드)

Flitz에서는 사용자 자신을 나타내는 프로필 카드를 생성할 수 있습니다.
프로필 카드는 기존 게이 데이팅 앱에서의 정형화된 형식의 프로필이 아닌, 사용자가 자유롭게 꾸밀 수 있는 형태로 제공되며 **3D로 렌더링**되어 사용자에게 보여집니다.

- 카드 앞면에서는 Instagram의 스토리나 Twitter의 Fleet처럼, 자신을 나타내는 사진과 텍스트 등의 컨텐츠를 자유롭게 배치할 수 있습니다.
- 카드 뒷면에는 Jack'd나 Grindr처럼 프로필의 상세 정보 필드를 기재할 수 있습니다.
- 카드 프레임 또한 데코레이션 아이템을 사용하여 자유롭게 꾸밀 수 있습니다.

## 데코레이션 아이템

카드 앞면이나 프레임 등에 사용되는 데코레이션 아이템은 **유료**로 구매할 수 있으며, 일부 아이템은 **이벤트** 등을 통해 무료로 획득할 수 있습니다.

- **카드 프레임**
- **스티커**
- **코팅 효과**

또한, **그래픽 디자이너, 아티스트, 브랜드와의 콜라보레이션 상품도 판매**될 수 있습니다.

---

# 카드 교환 시스템

Flitz에서 사용자들이 서로를 발견하는 방법은 간단합니다. 단지 휴대폰에 Flitz 앱을 설치해놓고, 바깥을 돌아다니다 보면 **어느새 프로필 카드가 교환**되어 있는 것을 발견할 수 있습니다.

Flitz 앱은 **Bluetooth LE + GPS**를 사용하여 주변에 있는 Flitz 사용자들과 프로필 카드를 자동으로 교환합니다. 사용자는 교환된 카드를 확인하고, 상대방에게 호감을 표시할 수 있습니다. 상대방도 마찬가지로 사용자의 카드를 확인하고 호감을 표시할 수 있습니다.

호감이 서로 교환되면, 사용자들은 서로 매칭되어 채팅을 할 수 있습니다.

## 메시징 시스템

매칭된 사용자들은 Direct Message를 통해 대화를 나눌 수 있습니다.

### 주요 기능
- **텍스트 메시지**: 일반적인 텍스트 기반 대화
- **이미지 첨부**: 사진을 첨부하여 전송 가능 (썸네일 자동 생성)
- **읽음 표시**: 상대방이 메시지를 읽었는지 확인 가능
- **실시간 알림**: WebSocket을 통한 실시간 메시지 수신

### 보안 및 안전 기능
- 매칭되지 않은 사용자와는 대화 불가
- 부적절한 메시지 신고 기능
- 메시지 삭제 기능 (본인이 보낸 메시지만)

## DELAYED EXCHANGE

**Flitz 앱은 다른 사용자와 카드가 교환되었더라도, 곧바로 상대방의 카드를 표시하지 않습니다. 카드가 교환된 후 사용자에게 표시되려면 아래 조건을 만족해야 합니다.**

> TODO: 인스턴트하지 않은, 슬로우한 카드 교환을 의도하고 있는데, 이대로도 괜찮을까요? 사용자가 질려할 수도 있을 것 같은데요.

### soft condition

이 조건을 **전부** 만족하면 사용자에게 카드가 표시됩니다.

- 카드 교환 지점으로부터 2km 이상 멀어져야 함
- 카드 교환 시점으로부터 2시간 이상 경과해야 함

### hard condition

soft condition을 만족할 수 없는 경우, 이 조건 중 하나를 만족하면 사용자에게 카드가 표시됩니다.

- 카드 교환 지점으로부터 15km 이상 멀어져야 함
- 카드 교환 시점으로부터 24시간 이상 경과해야 함

### assertive condition

사용자의 안전을 최우선으로 하기 위해, 이 조건을 만족하지 않으면 앞의 조건들이 만족하더라도 사용자에게 카드가 표시되지 않습니다.

- opponent가 여전히 가까이 있으면 카드 표시하지 않음
- opponent가 **차단/제한 목록**에 등록되어 있으면 카드 표시하지 않음
- opponent가 **shadowban** 처리되어 있으면 카드 표시하지 않음

## PHASED REVEAL

- 첫 30분~1시간 이내에는 아예 표시가 안 되지만, 이후에는 (예: 1시간 후 + 1km 거리) 점진적으로 (blurry) 표시 가능.
- 구현이 복잡해질 수 있지만, “만나자마자 바로 공개되지 않는다” + “너무 오래 기다리지도 않는다”는 중간 솔루션이 될 수 있음.

phase = 0:
    완전 블러 이미지, 혹은 “기본 실루엣 + 닉네임/태그만” 표기
    예: 교환 직후 ~ 30분 (혹은 1시간) 이내

phase = 1:
    블러가 조금 줄어든 이미지, 혹은 “낮은 해상도” / “흐릿한 미리보기” 정도
    예: 1시간 ~ 2시간 경과 시점

phase = 2:
    완전한 카드 정보 공개 (Delayed Exchange 최종 상태)
    예: 2시간 이후 & 안전 거리(Soft Condition) 만족 시

---

# 사용자 보호 시스템

Flitz에서는 의도치 않은 아웃팅 방지를 위해, 사용자 자신을 보호할 수 있는 여러 보호 장치를 제공합니다. 이 보호 장치들은 사용이 강제 되지 않기 때문에 선택적으로 사용이 가능합니다.

현재 구상 중인 보호 시스템은 다음과 같습니다.

## FUZZY LOCATION

- Flitz 앱은 다른 게이 데이팅 앱과 다르게, 주변 사용자의 위치를 미터 거리 등의 수치로 표시하지 않습니다.
- 대신, Flitz 앱은 사용자의 위치를 "매우 가까움", "가까움", "중간", "멈", "매우 멈" 등의 텍스트로 표시합니다.

## 연락처 차단 및 제한

### 연락처 차단

- 사용자는 자신의 휴대폰에 저장된 연락처들을 Flitz 앱에 **차단 목록**으로 등록할 수 있습니다.
- 차단된 연락처에게는 Flitz 앱을 통해 사용자의 프로필 카드가 완전히 노출되지 않습니다.

### 연락처 제한

- 사용자는 자신의 휴대폰에 저장된 연락처들을 Flitz 앱에 **제한 목록**으로 등록할 수 있습니다.
- 제한 목록에 있는 연락처에게는 사용자의 프로필 카드가 표시되지만, 아래와 같은 제한이 적용됩니다.
    - 사용자의 프로필 카드가 회색 (단색)으로만 표시됨
    - 카드 중앙에 아래와 같은 메시지가 표시됨
    - 카드를 표시하려면 상대방에게 자신이 이 사용자의 카드를 조회했다는 알림이 전달됨

> 표시 제한된 사용자
> 
> 
> 당신이 알 수도 있는 사용자이기 때문에 이 프로필 카드는 표시가 제한되었습니다.
> 
> 아래 버튼을 누르면 카드를 표시할 수 있지만, 당신이 이 사용자의 카드를 조회했다는 사실이 상대방에게 알림으로 전달됩니다.
> 
> [표시하기]
> 

## 스토킹 방지

- Flitz 앱은 특정한 사용자가 자신의 프로필 카드를 비정상적으로 많이 조회하는 경우, 이 행위를 **스토킹**으로 간주하고, 해당 사용자를 shadowban 처리합니다.
- 추후 같은 휴대폰 번호나 같은 기기로 Flitz 앱을 다시 설치하여 사용하는 경우, 자동으로 shadowban 처리하고 스토킹 대상 사용자의 프로필 카드를 절대 표시하지 않습니다.

## 자동 오프라인 모드

- Flitz 앱은 사용자가 자신을 노출해선 안되는 상황에서 자신을 완전히 노출하지 않는 오프라인 모드로 전환합니다.
- 사용자가 오프라인 모드로 전환되면, 주변 사람들과의 프로필 카드 교환을 중단하고 채팅 알림 등을 완전히 표시하지 않습니다.
- 자동 오프라인 모드는 아래와 같은 트리거 조건을 설정할 수 있도록 하는 것을 구상하고 있습니다.
    - 사용자가 특정한 **위치**에 체류하고 있을 때 (예: 집, 회사, 학교 등)

## 사진 도용 방지 (옵트 아웃) 시스템

- 기존 데이팅 앱에서는 인플루언서나 일반 SNS 사용자들의 사진을 도용하는 악성 유저가 많았습니다.
- Flitz 앱에서는 이러한 도용 행위으로 인한 피해를 줄이기 위해 **사진 도용 방지 시스템**을 고안하였습니다.
    - 도용 피해를 겪고 있는 사람들로부터 자신을 증명할 수 있는 서류와 사진을 전달받으면, 사진으로부터 DNA를 추출(ResNet 등을 통한 feature map extract) 하여 **등록 금지 리스트**에 올립니다.
    - **등록 금지 리스트**에 올라간 사진들은 Flitz 앱 내에서 완전히 사용할 수 없게 됩니다.
- 사진에 담긴 얼굴을 인식하여, 해당 부분에 대한 DNA만을 추출해 사용하기 때문에 아래와 같은 이점이 있습니다.
    - 사진 자체가 서버에 저장되지 않습니다. (DNA가 저장되지만, DNA만으로는 절대 원본 사진을 만들어낼 수 없습니다)
    - 리사이즈나 필터를 사용해도 잡아낼 수 있습니다.
    *다만, 스티커나 얼굴 위에 낙서 등으로 덧칠을 한, 변형이 심한 것은 못 잡을 가능성이 있습니다..*

**사진 도용 방지 시스템**은 이러한 시나리오로 동작될 수 있습니다.

1. 지훈은 인스타그램에서 활동하는 인플루언서입니다. 그러나 데이팅 앱에서 자신의 사진을 도용하는 사람들이 가끔 있어 난감함을 겪고 있는 상황입니다.
2. 철호는 지훈의 사진을 도용하여 Flitz 앱에서 프로필을 생성하였고, 지훈 행세를 하고 다닙니다.
3. 지훈은 누군가 Flitz 앱에서 자신을 사칭하는 인물이 있다는 얘기를 들었습니다.
4. 지훈은 Flitz 앱의 고객 지원에 문의하여, 사진 도용 방지 시스템에 자신의 인스타그램 계정을 연동하였습니다.
5. Flitz 서버는 지훈의 인스타그램에 등록된 사진들로부터 **사진의 DNA**를 추출하여 블랙리스트에 올렸고, 철호의 계정은 곧바로 정지되었습니다.
6. 철호는 그 이후 다른 계정을 생성하여 같은 사진을 올리려 했지만, Flitz 서버에서 등록을 거부하여 도용을 포기하였습니다.
- 위 시나리오와 같은 케이스 외에도, 미리 선제적으로 옵트 아웃 신청을 해둠으로써 사진 도용을 사전에 차단할 수도 있습니다.

</section>
<section name="development">

# 개발 환경 및 기술 스택

## 기본 개발 환경
- **언어**: Swift
- **UI 프레임워크**: SwiftUI
- **타겟 플랫폼**: iOS
- **개발 도구**: Xcode

## 주요 사용 기술 및 프레임워크
- **네트워킹**: Alamofire
- **위치 서비스**: CoreLocation
- **근거리 통신**: CoreBluetooth (BLE)
- **3D 렌더링**: Metal 쉐이더, USDZ 파일 포맷
- **데이터 처리**: Codable 프로토콜, JSON 직렬화/역직렬화

# 프로젝트 구조

## 코드 구조
- **flitz/flitz/**: 메인 앱 소스 코드
  - **api/**: API 통신 관련 코드
    - **objdef/**: API 응답 데이터 모델 정의
      - **Messaging.swift**: 메시징 관련 데이터 모델
    - **FZAPIClient.swift**: HTTP 요청 처리 클라이언트
    - **FZAPIClient+Messaging.swift**: 메시징 API 메서드 구현
    - **FZAPIEndpoint.swift**: API 엔드포인트 정의
  - **elements/**: 카드 요소 관련 코드
    - **renderer/**: 카드 요소 렌더링 관련 코드
    - **FlitzCard.swift**: 카드 데이터 모델
    - **FlitzElement.swift**: 카드 요소 기본 프로토콜
    - **FlitzTextElement.swift**: 텍스트 요소 구현
    - **FlitzImageElement.swift**: 이미지 요소 구현
  - **flitzwave/**: Bluetooth LE 기반 근거리 통신 코드
    - **FlitzWaveCommunicator.swift**: 통신 코어 관리
    - **FlitzWaveDiscoverer.swift**: 주변 기기 탐색
    - **FlitzWaveBroadcaster.swift**: 기기 브로드캐스팅
  - **ui/**: 사용자 인터페이스 관련 코드
- **flitzTests/**: 단위 테스트
- **flitzUITests/**: UI 테스트

## 테스트 프로젝트
- **FlitzCardEditorTest/**: 카드 에디터 테스트 모듈
- **FlitzCardExchangeTest/**: 카드 교환 테스트 모듈
- **FlitzCardTest/**: 카드 테스트 모듈

# 코딩 규칙 및 패턴

## 명명 규칙
- **클래스/구조체 접두사**:
  - `FZ`: Flitz 앱의 모델 및 API 관련 클래스 (예: `FZAPIClient`, `FZUser`)
  - `Flitz`: 네임스페이스로 사용됨 (예: `Flitz.Card`, `Flitz.Element`)

## 아키텍처 패턴
- **MVVM**: `ObservableObject`, `@Published` 등을 활용한 MVVM 패턴 적용
- **의존성 주입**: 싱글톤보다는 의존성 주입 패턴 선호 (예: `FZAPIClient`를 이니셜라이저로 주입)

## 비동기 처리
- **async/await**: Swift의 모던 비동기 처리 패턴 사용
- **Task**: 비동기 작업 관리를 위한 Task API 활용

# 핵심 기능 구현

## 카드 시스템
- 카드는 3D로 렌더링되며, 앞면과 뒷면 구성 가능
- 카드에는 이미지 및 텍스트 요소를 자유롭게 배치 가능
- Metal 쉐이더를 사용한 특수 효과 (normal mapping 등) 지원

## FlitzWave (카드 교환 시스템)
- Bluetooth LE를 활용한 근거리 기기 발견 시스템
- 위치 정보와 함께 서버에 교환 정보 보고
- 사용자 안전을 위한 카드 표시 지연 기능 구현

## API 통신
- RESTful API 기반 통신
- 토큰 기반 인증 시스템
- 멀티파트 폼 데이터를 통한 이미지 업로드 지원

### 메시징 API

#### 엔드포인트
- `GET /conversations/` - 대화 목록 조회
- `POST /conversations/` - 새 대화 생성
- `DELETE /conversations/{id}/` - 대화 삭제
- `GET /conversations/{id}/messages/` - 메시지 목록 조회
- `POST /conversations/{id}/messages/` - 메시지 전송
- `DELETE /conversations/{id}/messages/{messageId}/` - 메시지 삭제
- `POST /conversations/{id}/messages/mark_as_read/` - 읽음 표시
- `POST /conversations/{id}/attachments/` - 이미지 첨부파일 업로드

#### 데이터 모델
- **DirectMessageConversation**: 대화 정보 (ID, 참여자, 최신 메시지)
- **DirectMessageParticipant**: 대화 참여자 정보 (사용자, 읽음 시간, 읽지 않은 메시지 수)
- **DirectMessage**: 메시지 정보 (ID, 발신자, 내용, 생성 시간)
- **DirectMessageContent**: 메시지 내용 (텍스트 또는 첨부파일)
- **DirectMessageAttachment**: 첨부파일 정보 (타입, URL, 썸네일 URL, 크기 등)

# 개발 참고 사항

1. **카드 에셋 처리**:
   - 로컬 이미지는 서버에 업로드 후 URL 참조로 변환됨
   - 이미지 DNA 추출 및 검증은 백엔드에서 처리

2. **비동기 작업 처리**:
   - UI 업데이트는 반드시 메인 스레드에서 수행 (`DispatchQueue.main.async`)
   - 네트워크 요청 및 블루투스 작업은 백그라운드에서 처리

3. **위치 권한**:
   - 앱은 항상 위치 권한(`authorizedAlways`)을 요구함
   - 백그라운드 위치 업데이트 활성화 필요

4. **보안 고려사항**:
   - 사용자 토큰은 앱 내부에만 저장
   - 민감한 통신은 HTTPS 사용
   - 사진 데이터는 DNA 추출 후 원본은 저장하지 않음

5. **메시징 시스템**:
   - 대화는 매칭된 사용자 간에만 가능
   - DirectMessageContent는 Union Type으로 구현 (텍스트/첨부파일)
   - 이미지 첨부 시 서버에서 자동으로 썸네일 생성
   - WebSocket을 통한 실시간 메시지 수신 지원
   - 읽음 표시는 conversation 단위로 처리

</section>
